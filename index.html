<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Maze Game - FPS</title>
<style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
</style>
</head>
<body>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";

//////////////////////////////////////////////////////////////
// SCENE + CAMERA + RENDERER
//////////////////////////////////////////////////////////////

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);
scene.fog = new THREE.FogExp2(0x111111, 0.05);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(2, 1.5, 5); // eye height ~1.5

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

//////////////////////////////////////////////////////////////
// LIGHTING
//////////////////////////////////////////////////////////////

const ambient = new THREE.AmbientLight(0xffffff, 0.3);
scene.add(ambient);

const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(10,20,10);
sun.castShadow = true;
scene.add(sun);

// Torch attached to camera
const torch = new THREE.PointLight(0xffeeaa, 0.8, 10);
camera.add(torch);
scene.add(camera);

//////////////////////////////////////////////////////////////
// TEXTURES
//////////////////////////////////////////////////////////////

const loader = new THREE.TextureLoader();
const wallTexture = loader.load("https://i.imgur.com/Jd2NPFf.jpeg");
wallTexture.wrapS = wallTexture.wrapT = THREE.RepeatWrapping;

const floorTexture = loader.load("https://i.imgur.com/yY6tjqm.jpeg");
floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;

//////////////////////////////////////////////////////////////
// FLOOR
//////////////////////////////////////////////////////////////

const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshStandardMaterial({ map: floorTexture, roughness: 0.8, metalness: 0.1 })
);
floor.rotation.x = -Math.PI/2;
floor.receiveShadow = true;
scene.add(floor);

//////////////////////////////////////////////////////////////
// MAZE
//////////////////////////////////////////////////////////////

const mazeData = [
"############",
"#..........#",
"#.######...#",
"#.#....#...#",
"#.#.##.#...#",
"#.#....#...#",
"#.######...#",
"#..........#",
"############"
];

const walls = [];

for(let z=0; z<mazeData.length; z++){
    for(let x=0; x<mazeData[z].length; x++){
        if(mazeData[z][x]==="#"){
            const wall = new THREE.Mesh(
                new THREE.BoxGeometry(1,2,1),
                new THREE.MeshStandardMaterial({ map: wallTexture, roughness:0.8, metalness:0.1 })
            );
            wall.position.set(x,1,z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            scene.add(wall);
            walls.push(wall);
        }
    }
}

//////////////////////////////////////////////////////////////
// SWORD
//////////////////////////////////////////////////////////////

const sword = new THREE.Mesh(
    new THREE.BoxGeometry(0.15, 1.2, 0.15),
    new THREE.MeshStandardMaterial({ color: 0xdddddd })
);
sword.position.set(0.3,-0.5,-1);
sword.rotation.set(-0.3,0,-0.2);
camera.add(sword);

//////////////////////////////////////////////////////////////
// PLAYER MOVEMENT
//////////////////////////////////////////////////////////////

const keys = {};
let pitch = 0;
let yaw = 0;

window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// Mouse look
let isLocked = false;
document.body.addEventListener("click", () => {
    renderer.domElement.requestPointerLock();
});

document.addEventListener('pointerlockchange', () => {
    isLocked = document.pointerLockElement === renderer.domElement;
});

document.addEventListener("mousemove", (e) => {
    if(!isLocked) return;
    const sensitivity = 0.002;
    yaw -= e.movementX * sensitivity;
    pitch -= e.movementY * sensitivity;
    pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
});

function checkCollision(pos){
    for(const wall of walls){
        const dx = pos.x - wall.position.x;
        const dz = pos.z - wall.position.z;
        if(Math.abs(dx)<0.5 && Math.abs(dz)<0.5) return true;
    }
    return false;
}

function movePlayer(){
    const speed = 0.07;
    const direction = new THREE.Vector3();

    const forward = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
    const right = new THREE.Vector3().crossVectors(forward,new THREE.Vector3(0,1,0)).normalize();

    const nextPos = camera.position.clone();

    if(keys["w"]) nextPos.addScaledVector(forward,speed);
    if(keys["s"]) nextPos.addScaledVector(forward,-speed);
    if(keys["a"]) nextPos.addScaledVector(right,-speed);
    if(keys["d"]) nextPos.addScaledVector(right,speed);

    if(!checkCollision(nextPos)){
        camera.position.copy(nextPos);
    }

    camera.rotation.set(pitch, yaw, 0);
}

//////////////////////////////////////////////////////////////
// ANIMATION LOOP
//////////////////////////////////////////////////////////////

function animate(){
    requestAnimationFrame(animate);
    movePlayer();
    renderer.render(scene,camera);
}

animate();

//////////////////////////////////////////////////////////////
// RESIZE
//////////////////////////////////////////////////////////////

window.addEventListener("resize", ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>
